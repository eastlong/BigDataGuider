MyBatis入门教程（一）：MyBatis初体验
<!-- TOC -->

- [1. 知识准备](#1-知识准备)
    - [1.1. 什么是框架？](#11-什么是框架)
    - [1.2. 三层架构](#12-三层架构)
    - [1.3. 持久层技术解决方案](#13-持久层技术解决方案)
    - [1.4. mybatis的概述](#14-mybatis的概述)
    - [1.5. Mybastis简介](#15-mybastis简介)
- [2. MyBatis入门案例](#2-mybatis入门案例)
    - [2.1. 需求分析](#21-需求分析)
    - [2.2. 准备工作](#22-准备工作)
        - [2.2.1. pom依赖](#221-pom依赖)
        - [2.2.2. 创建数据库和表](#222-创建数据库和表)
    - [2.3. User实体类](#23-user实体类)
    - [2.4. 编写持久层接口](#24-编写持久层接口)
    - [2.5. 编写持久层接口的映射文件IUSerDao.xml](#25-编写持久层接口的映射文件iuserdaoxml)
    - [2.6. 其他配置文件](#26-其他配置文件)
        - [2.6.1. 在SqlMapConfig.xml加载映射文件](#261-在sqlmapconfigxml加载映射文件)
        - [2.6.2. 测试类](#262-测试类)

<!-- /TOC -->

# 1. 知识准备
## 1.1. 什么是框架？
它是我们软件开发中的一套解决方案，不同的框架解决的是不同的问题。
使用框架的好处：  
**框架封装了很多的细节，使开发者可以使用极简的方式实现功能。大大提高开发效率。**
## 1.2. 三层架构
* 表现层：
是用于展示数据的-->和前端打交道
* 业务层：
是处理业务需求
* 持久层：
是和数据库交互的

## 1.3. 持久层技术解决方案
JDBC技术：  
* Connection  
* PreparedStatement  
* ResultSet   
**Spring的JdbcTemplate：**
* Spring中对jdbc的简单封装  
* Apache的DBUtils：  
它和Spring的JdbcTemplate很像，也是对Jdbc的简单封装  
以上这些都不是框架  
**JDBC是规范**  
Spring的JdbcTemplate和Apache的DBUtils都只是工具类

## 1.4. mybatis的概述
mybatis是一个持久层框架，用java编写的。
它封装了jdbc操作的很多细节，使开发者只需要关注sql语句本身，而无需关注注册驱动，创建连接等繁杂过程
它使用了ORM思想实现了结果集的封装。

**ORM：**
**Object Relational Mappging 对象关系映射**
简单的说：  
**就是把数据库表和实体类及实体类的属性对应起来；让我们可以操作实体类就实现操作数据库表。**
user	User  
id	userId  
user_name	userName  
今天我们需要做到：  
实体类中的属性和数据库表的字段名称保持一致。  
user	User  
id	id  
user_name	user_name  

## 1.5. Mybastis简介
1. MyBatis是一个优秀的持久层框架，它对jdbc的操作数据库的过程进行封装，使开发者只需要关注 SQL 本身，而不需要花费精力去处理例如注册驱动、创建connection、创建statement、手动设置参数、结果集检索等jdbc繁杂的过程代码。

2. Mybatis通过xml或注解的方式将要执行的各种statement（statement、preparedStatemnt、CallableStatement）配置起来，并通过java对象和statement中的sql进行映射生成最终执行的sql语句，最后由mybatis框架执行sql并将结果映射成java对象并返回。

3. mapper.xml文件即sql映射文件，文件中配置了操作数据库的sql语句。此文件需要在SqlMapConfig.xml中加载。

4. 通过mybatis环境等配置信息构造SqlSessionFactory即会话工厂

5. 由会话工厂创建sqlSession即会话，操作数据库需要通过sqlSession进行。

6. mybatis底层自定义了Executor执行器接口操作数据库，Executor接口有两个实现，一个是基本执行器、一个是缓存执行器。

7. Mapped Statement也是mybatis一个底层封装对象，它包装了mybatis配置信息及sql映射信息等。mapper.xml文件中一个sql对应一个Mapped Statement对象，sql的id即是Mapped statement的id。

8. Mapped Statement对sql执行输入参数进行定义，包括HashMap、基本类型、pojo，Executor通过Mapped Statement在执行sql前将输入的java对象映射至sql中，输入参数映射就是jdbc编程中对preparedStatement设置参数。

9. Mapped Statement对sql执行输出结果进行定义，包括HashMap、基本类型、pojo，Executor通过Mapped Statement在执行sql后将输出结果映射至java对象中，输出结果映射过程相当于jdbc编程中对结果的解析处理过程。

# 2. MyBatis入门案例
## 2.1. 需求分析
* 根据用户id（主键）查询用户信息
* 根据用户名称模糊查询用户信息
* 添加用户
* 删除用户
* 更新用户

## 2.2. 准备工作
### 2.2.1. pom依赖
<details>
  <summary>pom.xml</summary>
  
  ```xml
<dependencies>
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.4.5</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.6</version>
        </dependency>
        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>1.2.12</version>
        </dependency>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.12</version>
        </dependency>
    </dependencies>
  ```
</details>

### 2.2.2. 创建数据库和表
```sql
create database eesy_mybasts;

CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(40) NOT NULL,
  `age` int(3) NOT NULL,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=50 DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC

```

## 2.3. User实体类
<details>
  <summary>源代码</summary>
  
  ```java
package domain;

public class User implements Serializable{
    private Integer id;
    private String username;
    private Date birthday;
    private String sex;
    private String address;
    //省略getter setter
}
  ```
</details>

## 2.4. 编写持久层接口
<details>
  <summary>IUserDao.java</summary>
  
  ```java
package com.itheima.dao;

import com.itheima.domain.User;

import java.util.List;

public interface IUserDao {
    /**
     * 查询所有操作
     * @return
     */
    List<User> findAll();
    /**
     * 保存用户操作
     */
    boolean saveUser(User user);

    /**
     *  更新用户操作
     * @param user
     */
    boolean updateUser(User user);

    /**
     * 根据id删除用户信息操作
     * @param userId
     */
    boolean deleteUser(int userId);

    /**
     *  根据id查询用户信息
     */
    User findById(int userId);

    /**
     * 根据名称模糊查询用户信息 like
     * 注意在模糊查询时 传的 字符串前后 需手动加入"%"
     */
    List<User>findByUserame(String username);

    /**
     * 用聚合函数查询总人数
     **/
    int findTotal();
}

  ```
</details>





## 2.5. 编写持久层接口的映射文件IUSerDao.xml
* 要求：
    * 创建位置： 必须和持久层接口在相同的包中。
    * 名称： 必须以持久层接口名称命名文件名，扩展名是.xml

* 映射文件命名：
User.xml（原始ibatis命名）
MyBatis的mapper代理开发映射文件名称叫XXXMapper.xml
比如：UserMapper.xml、ItemsMapper.xml。  
此处为了方便，直接写：IUSerDao.xml  

* 在映射文件中配置sql语句
    * 在classpath下对应的目录下创建sql映射文件Users.xml： 
    * namespace ： 命名空间，用于隔离sql语句，后面会讲另一层非常重要的作用。
    * 配置参数说明

        * id：标识 映射文件中的 sql ，将sql语句封装到mappedStatement对象中，所以将id称为statement的id。
        * parameterType：指定输入 参数的类型，这里指定int型;
        * resultType：指定sql输出结果的所映射的java对象类型;
        * select指定resultType表示将单条记录映射成的java对象。

```txt
#{}表示一个占位符号
#{id}：其中的id表示接收输入的参数，参数名称就是id，如果输入 参数是简单类型，#{}中的参数名可以任意，可以value或其它名称
```
    
<details>
  <summary>IUserDao.xml</summary>
  
  ```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itheima.dao.IUserDao">
    <!--配置查询所有-->
    <select id="findAll" resultType="com.itheima.domain.User">
        select * from user
    </select>

    <!--    配置根据id查询用户信息-->
    <select id="findById" parameterType="int" resultType="com.itheima.domain.User">
        SELECT * from user where id=#{id};
    </select>
    <!--    配置根据username模糊查询用户信息-->
    <select id="findByUserame" resultType="com.itheima.domain.User" parameterType="String">
        select * from user where username like #{username};
    </select>
    <!--    配置使用聚合函数查询总人数-->
    <select id="findTotal" resultType="int">
        select count(id) from user;
    </select>
    <!--    配置保存用户-->
    <insert id="saveUser" parameterType="com.itheima.domain.User">
        insert into user(username,address,sex,birthday) values(#{username},#{address},#{sex},#{birthday});
    </insert>
    <!--    配置更新用户-->
    <update id="updateUser" parameterType="com.itheima.domain.User">
        update user set username=#{username},address=#{address},sex=#{sex},birthday=#{birthday} where id=#{id};
    </update>
    <!--    配置删除用户-->
    <delete id="deleteUser" parameterType="int">
        delete from user where id=#{id};
    </delete>
</mapper>
  
  ```
</details>

## 2.6. 其他配置文件

1.log4j.properties日志配置文件
<details>
  <summary>log4j.properties</summary>
  
```properties
# 3. Set root category priority to INFO and its only appender to CONSOLE.
# 4. log4j.rootCategory=INFO, CONSOLE            debug   info   warn error fatal
log4j.rootCategory=debug, CONSOLE, LOGFILE

# 5. Set the enterprise logger category to FATAL and its only appender to CONSOLE.
log4j.logger.org.apache.axis.enterprise=FATAL, CONSOLE

# 6. CONSOLE is set to be a ConsoleAppender using a PatternLayout.
log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender
log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout
log4j.appender.CONSOLE.layout.ConversionPattern=%d{ISO8601} %-6r [%15.15t] %-5p %30.30c %x - %m\n

# 7. LOGFILE is set to be a File appender using a PatternLayout.
log4j.appender.LOGFILE=org.apache.log4j.FileAppender
log4j.appender.LOGFILE.File=d:\axis.log
log4j.appender.LOGFILE.Append=true
log4j.appender.LOGFILE.layout=org.apache.log4j.PatternLayout
log4j.appender.LOGFILE.layout.ConversionPattern=%d{ISO8601} %-6r [%15.15t] %-5p %30.30c %x - %m\n


```
</details>

2.MyBatis配置文件
### 2.6.1. 在SqlMapConfig.xml加载映射文件
* 在sqlMapConfig.xml中加载User.xml;
    * parameterType：定义输入到sql中的映射类型，#{id}表示使用preparedstatement设置占位符号并将输入变量id传到sql。
    * resultType：定义结果映射类型。


<details>
  <summary>SqlMapConfig.xml</summary>
  
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<!-- mybatis的主配置文件 -->
<configuration>
    <!-- 配置环境 -->
    <environments default="mysql">
        <!-- 配置mysql的环境-->
        <environment id="mysql">
            <!-- 配置事务的类型-->
            <transactionManager type="JDBC"></transactionManager>
            <!-- 配置数据源（连接池） -->
            <dataSource type="POOLED">
                <!-- 配置连接数据库的4个基本信息 -->
                <property name="driver" value="com.mysql.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/eesy_mybasts"/>
                <property name="username" value="root"/>
                <property name="password" value="123456"/>
            </dataSource>
        </environment>
    </environments>

    <!-- 指定映射配置文件的位置，映射配置文件指的是每个dao独立的配置文件 -->
    <mappers>
        <mapper resource="com/itheima/dao/IUserDao.xml"/>
    </mappers>
</configuration>
  
```
</details>

### 2.6.2. 测试类

<details>
  <summary>.java</summary>
  
  ```java
package com.itheima.dao;

import com.itheima.dao.IUserDao;
import com.itheima.domain.User;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;
import org.junit.Test;

import java.io.IOException;
import java.io.InputStream;
import java.util.Date;
import java.util.List;

public class IUserDaoTest {
    @Test
    public void testFindAll() throws IOException {

        //1.读取配置文件
        InputStream in = Resources.getResourceAsStream("SqlMapConfig.xml");
        //2.创建SqlSessionFactory工厂
        SqlSessionFactoryBuilder builder = new SqlSessionFactoryBuilder();
        SqlSessionFactory factory = builder.build(in);
        //3.使用工厂生产SqlSession对象
        SqlSession session = factory.openSession();
        //4.使用SqlSession创建Dao接口的代理对象
        IUserDao userDao = session.getMapper(IUserDao.class);
        //5.使用代理对象执行方法
        List<User> users = userDao.findAll();
        for (User user : users) {
            System.out.println(user);
        }
        //6.释放资源
        session.close();
        in.close();
    }

    @Test
//    测试保存操作
    public void testSaveUser() throws IOException {
        User user = new User();
        user.setUsername("鲁班七号");
        user.setSex("男");
        user.setBirthday(new Date());
        user.setAddress("召唤师峡谷");
        //读取配置文件,生成字节输出流
        InputStream inputStream = Resources.getResourceAsStream("SqlMapConfig.xml");
        //获取SqlSessionFactory
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        //获取SqlSession对象
        SqlSession session = factory.openSession();
        //获取dao的代理对象
        IUserDao mapper = session.getMapper(IUserDao.class);
        //保存User
        mapper.saveUser(user);

        //提交事务
        session.commit();
        //释放资源
        session.close();
        inputStream.close();
    }

    @Test
//    测试更新操作
    public void testUpdate() throws IOException {
        User user = new User();
        user.setId(6);
        user.setUsername("鲁班七号");
        user.setAddress("王者峡谷");
        user.setBirthday(new Date());
        user.setSex("男");


        //读取配置文件,生成字节输出流
        InputStream inputStream = Resources.getResourceAsStream("SqlMapConfig.xml");
        //获取SqlSessionFactory
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        //获取SqlSession对象
        SqlSession session = factory.openSession();
        //获取dao的代理对象
        IUserDao mapper = session.getMapper(IUserDao.class);
        //修改User
        mapper.updateUser(user);
        //提价事务
        session.commit();

        //释放资源
        session.close();
        inputStream.close();

    }

    @Test
    //测试删除User信息操作
    public void testDeleteUser() throws IOException {

        int userId = 9;

        //读取配置文件,获取字节输出资源流
        InputStream inputStream = Resources.getResourceAsStream("SqlMapConfig.xml");
        //获取SqlSessionFactory
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        //获取SqlSession对象
        SqlSession session = factory.openSession();
        //获取dao代理对象
        IUserDao mapper = session.getMapper(IUserDao.class);
        //删除User
        mapper.deleteUser(userId);
        //提交事务
        session.commit();
        //关闭对象
        session.close();
        inputStream.close();
    }

    @Test
    //测试根据id查询User信息
    public void testFindById() throws IOException {
        int userId = 3;
        //读取配置文件,获取字节输出资源流
        InputStream inputStream = Resources.getResourceAsStream("SqlMapConfig.xml");
        //获取SqlSessionFactoryBuilder
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        //获取SqlSession对象
        SqlSession session = factory.openSession();
        //获取dao代理对象
        IUserDao mapper = session.getMapper(IUserDao.class);
        //查询User信息
        User user = mapper.findById(userId);
        System.out.println();
        System.out.println(user);
        //释放资源
        session.close();
        inputStream.close();
    }

    @Test
    //根据Username查询User信息
    public void testFindByUsername() throws IOException {

        String username = "七";
        //读取配置文件,获取字节输出资源流
        InputStream inputStream = Resources.getResourceAsStream("SqlMapConfig.xml");
        //创建SplSessionFactory
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        //创建SqlSession对象
        SqlSession session = factory.openSession();
        //创建dao代理对象
        IUserDao mapper = session.getMapper(IUserDao.class);
        //查询User信息
        List<User> users = mapper.findByUserame("%" + username + "%");

        System.out.println();
        for (User user : users) {
            System.out.println(user);
        }
        //释放资源
        session.close();
        inputStream.close();
    }

    @Test
    //通过聚合函数查询总人数
    public void testFindTotal() throws IOException {
        //读取配置文件,获取字节输出资源流
        InputStream inputStream = Resources.getResourceAsStream("SqlMapConfig.xml");
        //创建SqlSessionFactory
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        //创建SqlSession对象
        SqlSession session = factory.openSession();
        //创建dao代理对象
        IUserDao mapper = session.getMapper(IUserDao.class);
        //查询总人数
        int total = mapper.findTotal();
        System.out.println();
        System.out.println(total);
        //释放资源
        session.close();
        inputStream.close();

    }
}

  ```
</details>

[源代码参考](https://github.com/eastlong/icode/tree/master/mybatis/start01_demo)



